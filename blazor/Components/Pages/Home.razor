@page "/"
@using blazor.Components.Data
@using blazor.Components.Servicios
@rendermode InteractiveServer
@inject ServicioControlador controlador

<PageTitle>Facturitas</PageTitle>

<h1>Facturitas de la plebada!!!</h1>
<hr style="height: 6px; background-color: rgb(0, 0, 0)">

<h4>@(facturaEnEdicion == null ? "Crear Nueva Factura" : $"Editando Factura ID: {facturaEnEdicion.Id}")</h4>
<hr style="height: 6px; background-color: rgb(0, 0, 0)">
<div>
    <label>Nombre Cliente:</label>
    <input @bind="nuevaFactura.NombreCliente" placeholder="Nombre del cliente" />
</div>
    <div>
        <label>Fecha:</label>
        <input @bind="nuevaFactura.Fecha" type="date"/>
    </div>

    <h4>@(articuloEdicion == null ? "Agregar Articulo" : "Editando articulo")</h4>
    <div>
        <input @bind="nuevoArticulo.Descripcion" placeholder="Descripción" />
        <input @bind="nuevoArticulo.Cantidad" type="number" placeholder="Cant" style="width: 60px;"/>
        <input @bind="nuevoArticulo.PrecioUnitario" type="number" placeholder="Precio U." style="width: 80px;"/>
        <button @onclick="AgregarOActualizarArticulo">
        @(articuloEdicion == null ? "Agregar Artículo" : "Actualizar Artículo")
    </button>

    @if (articuloEdicion != null)
    {
        <button @onclick="GuardarOActualizarFactura">Cancelar</button>
    }
    </div>
    <ul>
        @foreach (var item in nuevaFactura.Items)
        {
            <li>
                (@item.Cantidad) @item.Descripcion - @item.PrecioUnitario.ToString("C")
                Total: @item.TotalLinea.ToString("C")
                <button @onclick="() => nuevaFactura.Items.Remove(item)">X</button>
                <button @onclick="() => SeleccionarParaEditar(item)">Editar</button>
            </li>
        }
    </ul>
    <h4>Total Factura: @nuevaFactura.Total.ToString("C")</h4>

    <button @onclick="GuardarOActualizarFactura" disabled="@(nuevaFactura.Items.Count == 0)">
        @(facturaEnEdicion == null ? "Guardar Factura" : "Actualizar Factura")
    </button>
    
    @if (facturaEnEdicion != null)
    {
        <button @onclick="CancelarEdicionFactura">Cancelar Edición</button>
    }

<hr style="height: 6px; background-color: rgb(0, 0, 0)">

<h4>Facturas Guardadas</h4>
@if (controlador.facturas == null || controlador.facturas.Count == 0)
{
    <p>No hay facturas guardadas.</p>
}
else
{
    <hr style="height: 6px; background-color: rgb(0, 0, 0)">
    @foreach (var factura in controlador.facturas)
    {
        <div>
            <p>
                <strong>ID: @factura.Id</strong> | Fecha: @factura.Fecha
            </p>
            <p>
                Cliente: @factura.NombreCliente
            </p>
            <ul>
                @foreach (var item in factura.Items)
                {
                    <li>(@item.Cantidad) @item.Descripcion - @item.PrecioUnitario.ToString("C")</li>
                }
            </ul>
            <p style="text-align: right; font-weight: bold;">
                Total: @factura.Total.ToString("C")
            </p>
            
            <div style="text-align: right;">
                <button @onclick="() => SeleccionarFacturaParaEditar(factura)">Editar</button>
                <button @onclick="() => EliminarFacturaYRecargar(factura.Id)">Eliminar</button>
            </div>
        </div>
        <hr/>
    }
}

@code {
    private Factura nuevaFactura = new Factura();
    private Articulo nuevoArticulo = new Articulo();
    private Articulo articuloEdicion = null;
    private Factura facturaEnEdicion = null;

    protected override void OnInitialized()
    {
        controlador.CargarFacturas();
    }
    void SeleccionarParaEditar(Articulo item)
    {
        articuloEdicion = item;
        nuevoArticulo = new Articulo
        {
            Descripcion = item.Descripcion,
            Cantidad = item.Cantidad,
            PrecioUnitario = item.PrecioUnitario
        };

    }
    void AgregarOActualizarArticulo()
    {
       if (!string.IsNullOrWhiteSpace(nuevoArticulo.Descripcion) && nuevoArticulo.Cantidad > 0 && nuevoArticulo.PrecioUnitario > 0)
        {
            if (articuloEdicion == null)
            {
                var itemParaAgregar = new Articulo
                {
                    Descripcion = nuevoArticulo.Descripcion,
                    Cantidad = nuevoArticulo.Cantidad,
                    PrecioUnitario = nuevoArticulo.PrecioUnitario
                };
                nuevaFactura.Items.Add(itemParaAgregar);
            }
            else
            {
                articuloEdicion.Descripcion = nuevoArticulo.Descripcion;
                articuloEdicion.Cantidad = nuevoArticulo.Cantidad;
                articuloEdicion.PrecioUnitario = nuevoArticulo.PrecioUnitario;
            
            GuardarOActualizarFactura();
        }
    } 
    }
    void CancelarEdicionArticulo()
    {
        nuevoArticulo = new Articulo();
        articuloEdicion = null;
    }
    
    void GuardarOActualizarFactura()
    {
        nuevaFactura.Id = (facturaEnEdicion?.Id ?? 0);

        if (facturaEnEdicion == null)
        {
            controlador.AgregarFactura(nuevaFactura);
        }
        else
        {
            controlador.ActualizarFactura(nuevaFactura);
        }
        CancelarEdicionFactura();
    }
    
    void SeleccionarFacturaParaEditar(Factura factura)
    {
        facturaEnEdicion = factura;
        nuevaFactura = new Factura
        {
            Id = factura.Id,
            Fecha = factura.Fecha,
            NombreCliente = factura.NombreCliente,
            Items = new List<Articulo>()
        };
        foreach (var item in factura.Items)
        {
            nuevaFactura.Items.Add(new Articulo 
            {
                Id = item.Id,
                Descripcion = item.Descripcion,
                Cantidad = item.Cantidad,
                PrecioUnitario = item.PrecioUnitario,
                FacturaId = item.FacturaId
            });
        }
        CancelarEdicionArticulo();
    }
    void EliminarFacturaYRecargar(int id)
    {
        controlador.EliminarFactura(id);
        if (facturaEnEdicion != null && facturaEnEdicion.Id == id)
        {
            CancelarEdicionFactura();
        }
        StateHasChanged();
    }
    void CancelarEdicionFactura()
    {
        nuevaFactura = new Factura();
        facturaEnEdicion = null;
        CancelarEdicionArticulo();
    }

}